# Claude Commands Library v2.0 - Migration and Improvement Tutorial

**Version:** 1.0
**Date:** December 20, 2024
**Audience:** Developers, Contributors, Advanced Users

---

## Table of Contents

1. [Introduction](#introduction)
2. [What Changed in v2.0](#what-changed-in-v20)
3. [The Problem v2.0 Solves](#the-problem-v20-solves)
4. [Architecture Deep Dive](#architecture-deep-dive)
5. [Migration Guide](#migration-guide)
6. [Benefits Walkthrough](#benefits-walkthrough)
7. [Advanced Features](#advanced-features)
8. [Creating Custom Commands](#creating-custom-commands)
9. [Best Practices](#best-practices)
10. [Troubleshooting](#troubleshooting)

---

## Introduction

Version 2.0 of the Claude Commands Library represents a major architectural refactoring that eliminates code duplication, improves maintainability, and establishes a unified library system for all commands.

This tutorial will guide you through:
- Understanding the architectural changes
- Migrating existing custom commands
- Leveraging new features
- Following best practices

**Target Audience:**
- Developers creating custom commands
- Contributors to the library
- Users customizing commands for their workflow
- Anyone interested in clean architecture

---

## What Changed in v2.0

### High-Level Summary

**Before v2.0:**
```
Each command = Full Phase 0 implementation + Custom logic
Result: Lots of duplicate code
```

**After v2.0:**
```
Each command = Library reference + Custom logic
Result: Single source of truth
```

### Specific Changes

| Aspect | v1.0 | v2.0 |
|--------|------|------|
| Phase 0 Logic | Duplicated in each command | Referenced from library |
| Command Files | 500-1000 lines | 200-600 lines |
| Maintainability | Update N files | Update 1 file |
| Consistency | Varying implementations | Unified approach |
| Documentation | Inconsistent | Standardized |
| Advanced Features | Inline in commands | Reusable adapters |

### File Changes

**New Files:**
- `.claude/library/adapters/hybrid-adapter.md` - Advanced features library

**Modified Files:**
- All 7 command files updated with library references
- `CLAUDE.md` - Added v2.0 documentation section
- `README.md` - Added "What's New in v2.0" section

**Lines of Code:**
- **Removed:** ~500 lines of duplicate Phase 0 code
- **Added:** ~450 lines in hybrid-adapter.md (reusable)
- **Net Result:** Cleaner, more maintainable codebase

---

## The Problem v2.0 Solves

### Problem 1: Code Duplication

**Before v2.0:**

Each command had its own Phase 0 implementation:

```markdown
# prompt.md
## Phase 0: Prompt Perfection
[Full implementation of steps 0.1-0.6]

# prompt-hybrid.md
## Phase 0: Prompt Perfection
[Full implementation of steps 0.1-0.6 - DUPLICATE!]

# prompt-technical.md
## Phase 0: Prompt Perfection
[Full implementation of steps 0.1-0.6 - DUPLICATE!]
```

**Impact:**
- Same logic in 7 different files
- Bug fixes needed in multiple places
- Improvements hard to propagate
- High maintenance burden

**After v2.0:**

All commands reference the library:

```markdown
# All commands now use:
## Phase 0: Prompt Perfection
**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
**Adaptation:** [Domain-specific adapter if needed]
```

**Impact:**
- Fix bugs once, all commands benefit
- Improvements propagate automatically
- Low maintenance burden
- Guaranteed consistency

---

### Problem 2: Inconsistent Validation

**Before v2.0:**

Each command might validate differently:

```markdown
# Command A checks for:
- Goal, Context, Scope

# Command B checks for:
- Goal, Context, Scope, Requirements, Constraints

# Command C checks for:
- Goal, Context, Requirements

# Result: Inconsistent user experience
```

**After v2.0:**

All commands use the same 6 universal criteria:

```markdown
All commands check for:
- Goal
- Context
- Scope
- Requirements (optional)
- Constraints (optional)
- Expected Result

Plus domain-specific criteria from adapters
```

---

### Problem 3: Hard to Add Advanced Features

**Before v2.0:**

To add caching to multiple commands:

```markdown
1. Implement caching logic in prompt-hybrid.md
2. Copy-paste to prompt-technical.md
3. Modify for slight differences
4. Test both implementations
5. Maintain two versions going forward

Time: Hours per command
Risk: Divergent implementations
```

**After v2.0:**

To add caching to multiple commands:

```markdown
1. Implement in hybrid-adapter.md once
2. Reference adapter from commands
3. Test once
4. All commands get the feature

Time: Minutes
Risk: None - single implementation
```

---

## Architecture Deep Dive

### The Library System

```
.claude/
â”œâ”€â”€ library/                          # Reusable components
â”‚   â”œâ”€â”€ prompt-perfection-core.md     # Universal Phase 0
â”‚   â””â”€â”€ adapters/                     # Domain-specific extensions
â”‚       â”œâ”€â”€ technical-adapter.md      # Technical commands
â”‚       â”œâ”€â”€ article-adapter.md        # Content creation
â”‚       â”œâ”€â”€ session-adapter.md        # Session management
â”‚       â””â”€â”€ hybrid-adapter.md         # Advanced features (v2.0)
â”‚
â”œâ”€â”€ commands/                         # Command implementations
â”‚   â”œâ”€â”€ prompt.md                     # References: core only
â”‚   â”œâ”€â”€ prompt-hybrid.md              # References: core + hybrid
â”‚   â”œâ”€â”€ prompt-technical.md           # References: core + technical + hybrid
â”‚   â”œâ”€â”€ prompt-article.md             # References: core + article
â”‚   â”œâ”€â”€ prompt-article-readme.md      # References: core + article
â”‚   â”œâ”€â”€ session-start.md              # References: core + session
â”‚   â””â”€â”€ session-end.md                # References: core + session
â”‚
â””â”€â”€ config/                           # Configuration (referenced by adapters)
    â”œâ”€â”€ complexity-rules.json
    â”œâ”€â”€ agent-templates.json
    â”œâ”€â”€ cache-config.json
    â”œâ”€â”€ verification-config.json
    â””â”€â”€ learning-config.json
```

### Flow: How a Command Works in v2.0

**Example: User runs `/prompt-hybrid Add authentication`**

```
1. Claude reads: .claude/commands/prompt-hybrid.md
   â†“
2. Command says: "Import Phase 0 from prompt-perfection-core.md"
   â†“
3. Claude loads: .claude/library/prompt-perfection-core.md
   â†“
4. Command says: "Adapt with hybrid-adapter.md"
   â†“
5. Claude loads: .claude/library/adapters/hybrid-adapter.md
   â†“
6. Execute combined logic:
   - Phase 0 Steps 0.1-0.6 (from core)
   - Complexity detection (from hybrid adapter)
   - Agent spawning if needed (from hybrid adapter)
   - Caching (from hybrid adapter)
   â†“
7. Continue to command-specific Phase 1 logic
```

**Key Insight:** Commands are now **composers** not **implementers**.

---

### The Adapter Pattern

Adapters extend Phase 0 for specific domains:

**Core Library (Universal):**
```markdown
## Step 0.2: Completeness Check
- [ ] Goal
- [ ] Context
- [ ] Scope
- [ ] Requirements (optional)
- [ ] Constraints (optional)
- [ ] Expected Result
```

**Technical Adapter (Extensions):**
```markdown
## Additional Technical Criteria:
- [ ] Tech Stack
- [ ] Architecture Patterns
- [ ] Code Location
- [ ] Testing Strategy
```

**Hybrid Adapter (Advanced Features):**
```markdown
## Enhancements:
1. Complexity Detection
2. Agent Context Gathering
3. Multi-Agent Verification
4. Learning System Integration
```

**Result:** Each command gets exactly what it needs.

---

## Migration Guide

### For Existing Custom Commands

If you created custom commands based on v1.0, here's how to migrate:

#### Step 1: Identify Duplicate Phase 0 Code

Look for this pattern in your command:

```markdown
## Phase 0: Prompt Perfection

### Step 0.1: Initial Analysis
[Implementation...]

### Step 0.2: Completeness Check
[Implementation...]

### Step 0.3: Clarification Questions
[Implementation...]

### Step 0.4: Correction & Structuring
[Implementation...]

### Step 0.5: Output Perfect Prompt
[Implementation...]

### Step 0.6: Approval Gate
[Implementation...]
```

If you have all 6 steps implemented inline, you have duplicate code.

---

#### Step 2: Replace with Library Reference

**Before:**
```markdown
## Phase 0: Prompt Perfection

### Step 0.1: Initial Analysis
- Detect language (Slovak / English)
- Identify prompt type
- Extract core intent

[... 200+ lines of Phase 0 implementation ...]
```

**After:**
```markdown
## Phase 0: Prompt Perfection

**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
**Adaptation:** None (or choose appropriate adapter)

[Optional: Add domain-specific criteria if needed]
```

**Savings:** 200-400 lines removed!

---

#### Step 3: Choose Appropriate Adapter

Based on your command's domain:

| Domain | Adapter | Examples |
|--------|---------|----------|
| General prompt perfection | None | `/prompt` |
| Technical/coding tasks | `technical-adapter.md` | `/prompt-technical` |
| Content creation | `article-adapter.md` | `/prompt-article` |
| Session management | `session-adapter.md` | `/session-start` |
| Advanced features (agents, caching) | `hybrid-adapter.md` | `/prompt-hybrid` |

**Example:**

```markdown
## Phase 0: Prompt Perfection

**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
**Adaptation:** Technical (from `.claude/library/adapters/technical-adapter.md`)

**Additional Criteria:**
- [ ] Programming Language
- [ ] Framework Version
- [ ] Dependencies
```

---

#### Step 4: Add Documentation Sections

All v2.0 commands should have:

**1. Version History:**
```markdown
## Version History

**v2.0 (2024-12-20):**
- Migrated to unified library system
- References prompt-perfection-core.md
- [Other changes specific to your command]

**v1.0 (Previous):**
- Initial release
- [Original features]
```

**2. Library Integration:**
```markdown
## Library Integration

This command uses the **Unified Library System:**
- **Core:** `.claude/library/prompt-perfection-core.md` (universal Phase 0)
- **Adapter:** [your adapter or "None"]
- **Benefits:** Consistent validation, proven flow, easy maintenance

For details on the library system, see: `doc/Unified_Library_System_Guide.md`
```

---

#### Step 5: Test Your Migrated Command

```powershell
# Run validation tests
.\tests\validate-library-references.ps1

# Test the command manually
# (In Claude Code terminal)
/your-custom-command test input
```

**Checklist:**
- [ ] Library reference present
- [ ] Adapter referenced (if used)
- [ ] Version history added
- [ ] Library Integration section added
- [ ] Command executes without errors
- [ ] Phase 0 validation works
- [ ] Custom Phase 1 logic intact

---

### Migration Example: Before & After

**Before (v1.0) - 856 lines:**

```markdown
# /my-code-review - Code Review Command

## Phase 0: Prompt Perfection

### Step 0.1: Initial Analysis
- Detect language (Slovak / English)
- Identify prompt type: Code Review
- Extract the core intent: What code to review and how

**Input:**
> $ARGUMENTS

**Output:**
Detected Language: English
Prompt Type: Code Review
Core Intent: Review code for quality issues

---

### Step 0.2: Completeness Check

Verify the prompt contains:
- [ ] **Goal:** Clear desired outcome
- [ ] **Context:** Project, technology, environment
- [ ] **Scope:** Which files, components, areas
- [ ] **Constraints:** Performance, security, compatibility (optional)
- [ ] **Success Criteria:** How to verify it's done

**Code Review Specific:**
- [ ] **File/PR to Review:** Specific file or PR URL
- [ ] **Review Focus:** Security / Performance / Style / All
- [ ] **Depth Level:** Quick / Standard / Thorough

**For each missing item, mark it and prepare questions.**

---

### Step 0.3: Clarification Questions

[... 150 more lines of inline Phase 0 implementation ...]

---

### Step 0.4: Correction & Structuring

[... 100 more lines ...]

---

### Step 0.5: Output Perfect Prompt

[... 100 more lines ...]

---

### Step 0.6: Approval Gate

[... 50 more lines ...]

---

## Phase 1: Execute Code Review

[... 400 lines of actual code review logic ...]
```

**After (v2.0) - 506 lines:**

```markdown
# /my-code-review - Code Review Command

**Purpose:** Perform comprehensive code review with AI assistance.

## Phase 0: Prompt Perfection

**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
**Adaptation:** Technical (from `.claude/library/adapters/technical-adapter.md`)

**Additional Code Review Criteria:**
- [ ] **File/PR to Review:** Specific file or PR URL
- [ ] **Review Focus:** Security / Performance / Style / All
- [ ] **Depth Level:** Quick / Standard / Thorough

---

## Phase 1: Execute Code Review

[... 400 lines of actual code review logic ...]
[... SAME AS BEFORE - no changes needed ...]

---

## Version History

**v2.0 (2024-12-20):**
- Migrated to unified library system
- References prompt-perfection-core.md and technical-adapter.md
- Eliminated 350 lines of duplicate Phase 0 code

**v1.0 (2024-11-01):**
- Initial release
- Inline Phase 0 implementation
- Code review logic for multiple languages

---

## Library Integration

This command uses the **Unified Library System:**
- **Core:** `.claude/library/prompt-perfection-core.md` (universal Phase 0)
- **Adapter:** `.claude/library/adapters/technical-adapter.md` (technical domain)
- **Benefits:** Consistent validation, proven flow, easy maintenance
```

**Savings:**
- Lines removed: 350
- Maintenance burden: 80% reduction
- Consistency: 100% guaranteed

---

## Benefits Walkthrough

### Benefit 1: Update Once, Fix Everywhere

**Scenario:** Bug found in Phase 0 Step 0.3 (Clarification Questions)

**Before v2.0:**
```
1. Fix bug in prompt.md
2. Copy fix to prompt-hybrid.md
3. Copy fix to prompt-technical.md
4. Copy fix to prompt-article.md
5. Copy fix to prompt-article-readme.md
6. Copy fix to session-start.md
7. Copy fix to session-end.md
8. Test all 7 commands
9. Hope you didn't introduce inconsistencies

Time: 2-4 hours
Risk: High (manual copy-paste errors)
Commands affected: 7
```

**After v2.0:**
```
1. Fix bug in prompt-perfection-core.md
2. Test with 2-3 commands
3. All 7 commands automatically fixed

Time: 15-30 minutes
Risk: Low (single edit)
Commands affected: 7 (automatically)
```

---

### Benefit 2: Easy to Add Commands

**Before v2.0:**
```markdown
To create new command:
1. Copy existing command (800+ lines)
2. Delete irrelevant sections
3. Modify Phase 0 for your domain
4. Add your Phase 1 logic
5. Test everything

Result: 600-800 line file
```

**After v2.0:**
```markdown
To create new command:
1. Reference library (3 lines)
2. Choose adapter (1 line)
3. Add domain criteria (10-20 lines)
4. Add your Phase 1 logic
5. Add documentation sections

Result: 200-400 line file

Bonus: Use example-custom-command.md template
```

---

### Benefit 3: Guaranteed Consistency

**Before v2.0:**

Different commands might ask different questions:

```
/prompt: "What's your goal?"
/prompt-technical: "What do you want to achieve?"
/prompt-article: "What's the desired outcome?"

Result: Confusing for users
```

**After v2.0:**

All commands use identical phrasing from library:

```
All commands: "What's your goal?" (from Step 0.2)

Result: Consistent user experience
```

---

### Benefit 4: Reusable Advanced Features

**Scenario:** Add agent result caching to commands

**Before v2.0:**
```
Implement caching in each command individually:
- prompt-hybrid.md: 150 lines of caching code
- prompt-technical.md: 150 lines of caching code
- Result: 300 lines total, 2 implementations to maintain
```

**After v2.0:**
```
Implement once in hybrid-adapter.md:
- hybrid-adapter.md: 150 lines of caching code
- Commands reference it: 1 line each
- Result: 150 lines total, 1 implementation to maintain
```

---

## Advanced Features

### Using the Hybrid Intelligence Adapter

The new `hybrid-adapter.md` provides enterprise-grade features:

**1. Complexity Detection**

Automatically determines if agent assistance is needed:

```markdown
Your prompt: "Add caching layer"
Score: 4 (Implementation = 3)
Result: Simple path (inline validation)

Your prompt: "Add caching following existing patterns in the codebase"
Score: 9 (Implementation = 3, Pattern detection = 6)
Result: Moderate (ask user if agent wanted)

Your prompt: "Implement distributed caching with Redis following existing patterns and ensuring compatibility with current architecture"
Score: 15 (Implementation = 3, Pattern = 6, Cross-cutting = 4, Feasibility = 4)
Result: Complex (spawn agent automatically) + Multi-agent verification
```

**2. Agent Result Caching**

First run:
```
Analyzing codebase... (20 seconds)
Found patterns: [results]
```

Second run (same prompt):
```
Cache hit! Loading previous analysis... (2 seconds)
Found patterns: [same results]

Speed improvement: 10x faster
```

**3. Multi-Agent Verification**

For critical operations (score >= 15):

```
Spawning 3 agents with different strategies...
1. Breadth-First (Haiku) - Wide coverage
2. Depth-First (Sonnet) - Detailed analysis
3. Pattern-Focused (Haiku) - Convention validation

Consensus: 85% agreement
Unanimous: Use Strategy A
Disagreement: Agent 2 suggests additional security layer

User chooses final approach
```

**4. Learning System**

After 3 similar prompts:

```
Pattern detected: "authentication" prompts missing security requirements

Suggested smart default:
When prompt contains "authentication", auto-include:
- Security checklist
- Password hashing method
- Token strategy

Apply? (yes/no)
```

---

### Enabling Advanced Features in Your Command

**Option 1: Reference Hybrid Adapter**

```markdown
## Phase 0: Prompt Perfection with Hybrid Intelligence

**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
**Adaptation:** Hybrid Intelligence (from `.claude/library/adapters/hybrid-adapter.md`)

**Enhanced Flow:**
1. Initial Analysis + Complexity Detection
2. IF complex â†’ Agent Context Gathering
3. Standard Phase 0 Steps enhanced with agent findings
```

**Option 2: Partial Features**

```markdown
## Phase 0: Prompt Perfection

**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
**Adaptation:** Technical + Complexity Detection only

**Use only complexity detection:**
- Add complexity scoring after Step 0.1
- Don't auto-spawn agents
- Let user decide with `--agent` flag
```

---

## Creating Custom Commands

### Quick Start with Template

```powershell
# Copy the example template
cp .claude/commands/example-custom-command.md .claude/commands/my-command.md

# Edit the file
code .claude/commands/my-command.md
```

### Minimal Command Structure

```markdown
# /my-command - Command Description

## Phase 0: Prompt Perfection

**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
**Adaptation:** None

## Phase 1: Execute Command

[Your custom logic here]

## Version History

**v1.0 (2024-12-20):**
- Initial release using v2.0 library system

## Library Integration

This command uses the **Unified Library System:**
- **Core:** `.claude/library/prompt-perfection-core.md`
- **Adapter:** None
```

That's it! You've created a v2.0-compliant command.

---

## Best Practices

### 1. Choose the Right Adapter

| Your Command Does | Use This Adapter |
|-------------------|------------------|
| General prompt perfection | None |
| Code/technical analysis | technical-adapter.md |
| Writing/content creation | article-adapter.md |
| Session/context management | session-adapter.md |
| Needs agents/caching/learning | hybrid-adapter.md |
| Unique domain | Create custom adapter |

### 2. Keep Phase 1 Focused

**Good:**
```markdown
## Phase 1: Generate Test Cases

**Step 1.1:** Analyze code structure
**Step 1.2:** Identify test scenarios
**Step 1.3:** Generate test code
**Step 1.4:** Output test suite
```

**Bad:**
```markdown
## Phase 1: Do Everything

[500 lines of mixed concerns]
```

### 3. Document Your Command

Minimum sections:
- Purpose/Overview
- Phase 0 reference
- Phase 1 logic
- Examples
- Version History
- Library Integration

### 4. Use Configuration for Flexibility

**Instead of hardcoding:**
```markdown
Threshold: 10
Max items: 50
Timeout: 30s
```

**Use configuration:**
```markdown
Read from: .claude/config/my-command-config.json
Threshold: config.threshold
Max items: config.max_items
Timeout: config.timeout
```

### 5. Test Before Committing

```powershell
# Validate library references
.\tests\validate-library-references.ps1

# Test command execution
# (in Claude Code)
/my-command test input

# Check for errors in output
```

---

## Troubleshooting

### Issue: "Library not found" error

**Symptom:**
```
Error: Cannot find .claude/library/prompt-perfection-core.md
```

**Cause:** Incorrect path or missing library file

**Solution:**
```powershell
# Verify library exists
Test-Path .\.claude\library\prompt-perfection-core.md

# If missing, re-run installer
.\install-claude-commands.ps1
```

---

### Issue: Phase 0 not executing correctly

**Symptom:** Command skips Phase 0 validation

**Cause:** Missing or malformed Import statement

**Solution:**

Check your command has this exact format:

```markdown
## Phase 0: Prompt Perfection

**Import:** Use Phase 0 from `.claude/library/prompt-perfection-core.md`
```

Not this:
```markdown
## Phase 0: Prompt Perfection
Import: Use Phase 0 from .claude/library/prompt-perfection-core.md
(Missing bold formatting)
```

---

### Issue: Adapter not loading

**Symptom:** Domain-specific criteria not being checked

**Cause:** Incorrect adapter reference or missing adapter file

**Solution:**

1. Verify adapter exists:
```powershell
Test-Path .\.claude\library\adapters\technical-adapter.md
```

2. Check reference format:
```markdown
**Adaptation:** Technical (from `.claude/library/adapters/technical-adapter.md`)
```

---

### Issue: Tests failing

**Symptom:**
```
[FAIL] prompt-hybrid - Missing version history section
```

**Solution:**

Add required sections to your command:

```markdown
## Version History

**v2.0 (2024-12-20):**
- Updated to v2.0 library system

## Library Integration

This command uses the **Unified Library System:**
- **Core:** `.claude/library/prompt-perfection-core.md`
```

Then re-run tests:
```powershell
.\tests\validate-library-references.ps1
```

---

## Conclusion

Version 2.0 of the Claude Commands Library represents a major step forward in:

âœ… **Maintainability** - Update once, all commands benefit
âœ… **Consistency** - Guaranteed uniform behavior
âœ… **Extensibility** - Easy to add new commands and features
âœ… **Quality** - Single source of truth eliminates bugs
âœ… **Developer Experience** - Clear patterns to follow

**Next Steps:**

1. **Explore the library:**
   - Read `prompt-perfection-core.md`
   - Study adapter files
   - Review example command

2. **Migrate existing commands:**
   - Follow migration guide above
   - Test thoroughly
   - Update documentation

3. **Create new commands:**
   - Use example template
   - Reference appropriate adapters
   - Follow best practices

4. **Contribute:**
   - Share custom adapters
   - Improve documentation
   - Report issues

**Resources:**

- [Command Reference Guide](Command_Reference_Guide.md)
- [Quick Reference](Quick_Reference.md)
- [CLAUDE.md](../CLAUDE.md) - Project overview
- [README.md](../README.md) - Getting started
- [Tests](../tests/) - Validation tools

---

**Welcome to v2.0 - Happy command building!** ðŸš€
